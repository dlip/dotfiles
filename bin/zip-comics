#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

# Image extensions to include
exts=("png" "jpg" "jpeg" "webp" "gif" "avif" "jxl")

# Loop through every subdirectory (recursive)
find . -type d | while read -r dir; do
  # Skip the top-level "."
  [[ "$dir" == "." ]] && continue

  # Gather images inside this directory
  images=()
  for ext in "${exts[@]}"; do
    while IFS= read -r -d '' img; do
      images+=("$img")
    done < <(find "$dir" -maxdepth 1 -type f -iname "*.$ext" -print0)
  done

  # Skip directories with no images
  ((${#images[@]} == 0)) && continue

  # Output file: <subdirectory>.cbz (base name only)
  parent="$(dirname "$dir")"
  base="$(basename "$dir")"
  out="$parent/$base.cbz"

  echo "Zipping: $dir -> $out"
  rm -f "$out"

  # Create the CBZ
  # -j strips paths so all images are at the ZIP root
  zip -j -r "$out" "${images[@]}"

  # Remove the subdirectory after success
  echo "Removing directory: $dir"
  rm -rf "$dir"
done
