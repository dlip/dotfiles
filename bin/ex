#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

########################################
# SUPPORTED EXTENSIONS
########################################

SUPPORTED_EXTS=(
  zip rar 7z tar gz tgz bz2 tbz tbz2 xz lzma iso cab wim arj z
)

########################################
# STATE
########################################

CURRENT_TMP_DIR=""

########################################
# FUNCTIONS
########################################

can_extract() {
  local f="$1"
  local ext="${f##*.}"
  ext="${ext,,}" # lowercase
  for e in "${SUPPORTED_EXTS[@]}"; do
    [[ "$e" == "$ext" ]] && return 0
  done
  return 1
}

on_interrupt() {
  echo "CTRL-C pressed, aborting…" >&2

  # Cleanup temp dir if it exists
  if [[ -n "${CURRENT_TMP_DIR}" && -d "${CURRENT_TMP_DIR}" ]]; then
    echo "Cleaning temporary directory: ${CURRENT_TMP_DIR}" >&2
    rm -rf "${CURRENT_TMP_DIR}" || true
  fi

  exit 1
}

extract_file() {
  local file="$1"

  # Skip unsupported extension
  if ! can_extract "$file"; then
    echo "Skipping unsupported file: $file"
    return
  fi

  local dir="$(dirname "$file")"
  local filename="$(basename "$file")"
  local base="${filename%.*}"
  local final_dir="$dir/$base"

  # Skip if already extracted
  if [[ -d "$final_dir" ]]; then
    echo "Skipping $file (directory '$final_dir' already exists)"
    return
  fi

  # Only now print processing
  echo "Processing: $file"

  # Hidden temp extraction folder on same filesystem
  local tmp_dir="$dir/.${base}.extracting_tmp"
  CURRENT_TMP_DIR="$tmp_dir"

  rm -rf "$tmp_dir"
  mkdir -p "$tmp_dir"

  # Trap Ctrl-C only during extraction
  trap on_interrupt INT

  # Extract quietly
  if ! 7z x -y "$file" -o"$tmp_dir" >/dev/null; then
    trap - INT
    echo "Extraction FAILED for: $file"
    rm -rf "$tmp_dir"
    CURRENT_TMP_DIR=""
    return
  fi

  # Disable Ctrl-C trap after extraction complete
  trap - INT

  # Count children
  children=("$tmp_dir"/*)

  # One directory only → unwrap it
  if ((${#children[@]} == 1)) && [[ -d "${children[0]}" ]]; then
    mv "${children[0]}" "$final_dir"
    rm -rf "$tmp_dir"

  else
    # Multiple items → wrap them
    mkdir -p "$final_dir"
    mv "$tmp_dir"/* "$final_dir"/
    rm -rf "$tmp_dir"
  fi

  CURRENT_TMP_DIR=""

  # Delete the archive if -d flag given
  if [[ "$DELETE_AFTER" == "1" ]]; then
    rm -f "$file"
  fi

  echo "Extracted: $file → $final_dir/"
}

########################################
# ARGUMENT HANDLING
########################################

DELETE_AFTER=0
input_path=""

while [[ $# -gt 0 ]]; do
  case "$1" in
  -d | --delete)
    DELETE_AFTER=1
    shift
    ;;
  *)
    input_path="$1"
    shift
    ;;
  esac
done

# Default to current directory
[[ -z "$input_path" ]] && input_path="."

########################################
# MAIN
########################################

if [[ -d "$input_path" ]]; then
  # Extract all files directly inside directory
  while IFS= read -r -d '' file; do
    extract_file "$file"
  done < <(find "$input_path" -maxdepth 1 -type f -print0)

else
  # Treat argument as file list
  for file in $input_path; do
    extract_file "$file"
  done
fi
