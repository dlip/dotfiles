#!/usr/bin/env bash
set -euo pipefail

DELETE_AFTER=false

# Parse -d flag
if [[ "${1:-}" == "-d" ]]; then
  DELETE_AFTER=true
  shift
fi

# Default to current directory
if [[ $# -eq 0 ]]; then
  set -- "."
fi

inputs=()

# Expand directories or add files
for arg in "$@"; do
  if [[ -d "$arg" ]]; then
    while IFS= read -r -d '' file; do
      inputs+=("$file")
    done < <(find "$arg" -maxdepth 1 -type f -print0)
  else
    inputs+=("$arg")
  fi
done

# Function to check if 7z can extract the file
can_extract() {
  7z t "$1" &>/dev/null
}

extract_file() {
  local file="$1"
  local name="$(basename "$file")"
  local base="${name%.*}"

  if ! can_extract "$file"; then
    echo "Skipping unsupported file: $file"
    return
  fi

  echo "==> Processing: $file"

  # List entries
  mapfile -t entries < <(7z l -ba "$file" | awk '{print $NF}')

  # Get top-level directories
  mapfile -t toplevel < <(
    for e in "${entries[@]}"; do
      [[ "$e" == */* ]] && echo "${e%%/*}"
    done | sort -u
  )

  local outdir=""

  if ((${#toplevel[@]} == 1)); then
    outdir="${toplevel[0]}"

    if [[ -d "$outdir" ]]; then
      echo " -> Directory '$outdir' already exists, skipping."
      return
    fi

    echo " -> Single top-level directory: extracting normally"
    7z x -y "$file"
  else
    outdir="$base"

    if [[ -d "$outdir" ]]; then
      echo " -> Directory '$outdir' already exists, skipping."
      return
    fi

    echo " -> Multiple items, extracting to '$outdir/'"
    mkdir -p "$outdir"
    7z x -y "$file" -o"$outdir"
  fi

  if $DELETE_AFTER; then
    echo " -> Deleting $file"
    rm -f "$file"
  fi
}

# Process each file
for f in "${inputs[@]}"; do
  extract_file "$f"
done

echo "Done."
